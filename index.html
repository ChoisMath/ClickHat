<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëª¨ì ë””íœìŠ¤: íƒí‹°ì»¬</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #1a202c;
            font-family: 'Jua', sans-serif;
            touch-action: none;
            user-select: none;
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* UI ë ˆì´ì–´ - ìƒë‹¨ HUDë§Œ */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            pointer-events: none;
            padding: 15px;
            box-sizing: border-box;
            z-index: 5;
        }

        /* ìƒë‹¨ HUD */
        .hud-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
        }

        /* í•˜ë‹¨ ì•„ì´í…œ ë°” - ê³ ì • footer */
        .item-bar-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 32, 44, 0.95);
            border-top: 2px solid #4A5568;
            padding: 8px 10px;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            z-index: 10;
            pointer-events: auto;
        }

        .item-bar {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding: 2px;
        }

        .item-bar::-webkit-scrollbar {
            display: none;
        }

        .item-slot {
            width: 50px;
            height: 50px;
            min-width: 50px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #4A5568;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.1s, border-color 0.2s;
        }

        .item-slot.active {
            border-color: #F6E05E;
            background: rgba(246, 224, 94, 0.25);
        }

        .item-slot:active {
            transform: scale(0.95);
        }

        .item-count {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #E53E3E;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .item-icon { font-size: 20px; }
        .item-name { font-size: 9px; color: #A0AEC0; margin-top: 1px; }

        /* ìƒì  ë²„íŠ¼ */
        #shop-btn-container { pointer-events: auto; }
        .cart-btn {
            background: #ED8936;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 0 #C05621;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .cart-btn:active { transform: scale(0.95); box-shadow: none; }

        .hud-text {
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            font-size: 20px;
            margin-bottom: 5px;
        }
        .coin-text { color: #F6E05E; font-size: 24px; }

        /* ëª¨ë‹¬ (ë©”ë‰´/ìƒì ) */
        #menu-screen, #shop-modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 20;
            pointer-events: auto;
            backdrop-filter: blur(5px);
        }
        #shop-modal { display: none; z-index: 30; }

        .shop-content {
            background: #2d3748;
            border-radius: 15px;
            padding: 20px;
            width: 95%; max-width: 500px;
            max-height: 80vh; overflow-y: auto;
            border: 2px solid #4a5568;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        .shop-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .btn {
            background: #e53e3e; color: white; padding: 12px 30px; font-size: 22px;
            border-radius: 50px; border: none; cursor: pointer;
            font-family: 'Jua', sans-serif; box-shadow: 0 4px 0 #9b2c2c; margin-top: 10px;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }

        .btn-shop {
            background: #4299E1; box-shadow: 0 3px 0 #2B6CB0; color: white;
            font-size: 15px; padding: 6px 12px; border-radius: 8px; min-width: 80px;
        }
        .btn-shop:disabled { background: #718096; box-shadow: none; cursor: not-allowed; opacity: 0.6; }
        .btn-equip { background: #48BB78; box-shadow: 0 3px 0 #2F855A; }
        .btn-close { background: #CBD5E0; color: #2D3748; box-shadow: 0 4px 0 #A0AEC0; margin-top: 20px; width: 100%; padding: 10px; border-radius: 10px; }

        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* ì•ˆë‚´ ë©”ì‹œì§€ */
        #notification {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: #F6E05E;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 24px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 50;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <!-- ì¸ê²Œì„ HUD (ìƒë‹¨) -->
    <div id="ui-layer">
        <div class="hud-top">
            <div>
                <div class="hud-text">íšë“: <span id="score">0</span> ì½”ì¸</div>
                <div class="hud-text coin-text">ğŸª™ <span id="coin-display">0</span></div>
            </div>

            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                <div id="shop-btn-container">
                    <button id="btn-open-shop" class="cart-btn">ğŸ›’</button>
                </div>
                <div class="hud-text mt-2" style="font-size: 16px; color: #63B3ED;">ê³µê²©ë ¥: <span id="dmg-display">1</span></div>
                <div class="hud-text" style="font-size: 16px; color: #FC8181;">ê´´ë¬¼: <span id="monster-count">0</span> / 15</div>
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ì•„ì´í…œ ë°” (ê³ ì • footer) -->
    <div class="item-bar-container" id="item-bar-container">
        <div class="item-bar">
            <!-- ê¸°ë³¸ ë¬´ê¸° (ì†ê°€ë½/ì‚°íƒ„ì´) -->
            <div class="item-slot active" id="slot-weapon" onclick="selectMode('WEAPON')">
                <div class="item-icon" id="weapon-icon">ğŸ‘†</div>
                <div class="item-name" id="weapon-name">ê¸°ë³¸</div>
            </div>

            <!-- ë ˆì´ì € -->
            <div class="item-slot" id="slot-laser" onclick="selectMode('LASER')">
                <div class="item-icon">âš¡</div>
                <div class="item-count" id="count-laser">0</div>
                <div class="item-name">ë ˆì´ì €</div>
            </div>

            <!-- ê·¸ë¬¼ -->
            <div class="item-slot" id="slot-net" onclick="selectMode('NET')">
                <div class="item-icon">ğŸ•¸ï¸</div>
                <div class="item-count" id="count-net">0</div>
                <div class="item-name">ê·¸ë¬¼</div>
            </div>
        </div>
    </div>

    <!-- ì¤‘ì•™ ì•Œë¦¼ ë©”ì‹œì§€ -->
    <div id="notification">ë©”ì‹œì§€</div>

    <!-- ë©”ì¸ ë©”ë‰´ -->
    <div id="menu-screen">
        <h1 class="text-4xl md:text-5xl text-white mb-2 text-center" style="text-shadow: 3px 3px 0 #000;">ğŸ© ëª¨ì ë””íœìŠ¤</h1>
        <p class="text-lg text-yellow-300 mb-6">Tactical Edition</p>
        
        <p id="game-over-msg" class="text-2xl text-red-400 mb-2 hidden font-bold">GAME OVER</p>
        <p id="final-score-display" class="text-xl text-white mb-4 hidden">íšë“: 0</p>

        <button class="btn" id="start-btn">ê²Œì„ ì‹œì‘</button>
        <button class="btn" style="background-color: #4A5568; font-size: 18px; margin-top: 15px;" onclick="openShop()">ìƒì  ì—´ê¸°</button>
    </div>

    <!-- ìƒì  ëª¨ë‹¬ -->
    <div id="shop-modal">
        <div class="shop-content">
            <h2 class="text-2xl text-white mb-4 text-center font-bold">ğŸ›’ ì•„ì´í…œ ìƒì </h2>
            <div class="text-yellow-400 mb-4 text-center border-b border-gray-600 pb-2">
                ë³´ìœ  ì½”ì¸: <span id="shop-coin">0</span>
            </div>

            <!-- 1. ê°•í™” -->
            <h3 class="text-lg text-blue-300 mb-2">âš¡ ëŠ¥ë ¥ì¹˜</h3>
            <div class="shop-item">
                <div>
                    <div class="text-white">ê³µê²©ë ¥ ê°•í™”</div>
                    <div class="text-gray-400 text-xs">Lv.<span id="shop-dmg">1</span> (ê´´ë¬¼ ì²´ë ¥ë„ ì¦ê°€)</div>
                </div>
                <button id="btn-upgrade-dmg" class="btn-shop">ê°•í™”</button>
            </div>

            <!-- 2. ë¬´ê¸° -->
            <h3 class="text-lg text-red-300 mb-2 mt-4">ğŸ”« ì „ìš© ë¬´ê¸°</h3>
            <div class="shop-item">
                <div>
                    <div class="text-white">ì‚°íƒ„ì´ (Shotgun) <span id="shop-gun-lv" class="text-yellow-400"></span></div>
                    <div class="text-gray-400 text-xs" id="shop-gun-desc">ì˜êµ¬ ì¥ì°© / ë²”ìœ„ ê³µê²©</div>
                </div>
                <button id="btn-buy-gun" class="btn-shop">êµ¬ë§¤ (400)</button>
            </div>

            <!-- 3. ì†Œëª¨í’ˆ -->
            <h3 class="text-lg text-purple-300 mb-2 mt-4">ğŸ’ ì†Œëª¨í’ˆ (ì—¬ëŸ¬ê°œ êµ¬ë§¤ ê°€ëŠ¥)</h3>
            <div class="shop-item">
                <div>
                    <div class="text-white">ë ˆì´ì € (Laser)</div>
                    <div class="text-gray-400 text-xs">ê°€ë¡œ í•œ ì¤„ ì¦‰ì‹œ ì‚­ì œ</div>
                </div>
                <button id="btn-buy-laser" class="btn-shop" onclick="buyConsumable('laser', 300)">êµ¬ë§¤ (300)</button>
            </div>
            <div class="shop-item">
                <div>
                    <div class="text-white">ê·¸ë¬¼ (Net)</div>
                    <div class="text-gray-400 text-xs">ë²”ìœ„ ë‚´ ì  3ì´ˆ ì •ì§€</div>
                </div>
                <button id="btn-buy-net" class="btn-shop" onclick="buyConsumable('net', 250)">êµ¬ë§¤ (250)</button>
            </div>

            <!-- 4. ìš©ë³‘ -->
            <h3 class="text-lg text-green-300 mb-2 mt-4">ğŸ¦– ìš©ë³‘ (ì´ë²ˆ íŒë§Œ ìœ ì§€)</h3>
            <div class="shop-item">
                <div>
                    <div class="text-white">ê³ ì§ˆë¼</div>
                    <div class="text-gray-400 text-xs">ë°°ì¹˜í˜• / ìŠ¬ë¡œìš° & ìë™ê³µê²©</div>
                </div>
                <button id="btn-buy-godzilla" class="btn-shop" onclick="buyGodzilla()">êµ¬ë§¤ (400)</button>
            </div>

            <button class="btn btn-close" onclick="closeShop()">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // --- ê²Œì„ ì„¤ì • ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const MAX_MONSTERS = 15;
        const ITEM_BAR_HEIGHT = 70; // ì•„ì´í…œ ë°” ë†’ì´ (íŒ¨ë”© í¬í•¨)

        // ê²Œì„ ì˜¤ë²„ ë¼ì¸ (ì•„ì´í…œ ë°” ìœ„)
        function getGameOverLine() {
            return canvas.height - ITEM_BAR_HEIGHT;
        }

        // UI ìš”ì†Œ
        const ui = {
            score: document.getElementById('score'),
            coins: document.getElementById('coin-display'),
            monsters: document.getElementById('monster-count'),
            dmg: document.getElementById('dmg-display'),
            menu: document.getElementById('menu-screen'),
            shopModal: document.getElementById('shop-modal'),
            notification: document.getElementById('notification'),
            
            // ìƒì 
            shopCoin: document.getElementById('shop-coin'),
            shopDmg: document.getElementById('shop-dmg'),
            btnUpgrade: document.getElementById('btn-upgrade-dmg'),
            btnBuyGun: document.getElementById('btn-buy-gun'),

            // ì•„ì´í…œ ìŠ¬ë¡¯
            slotWeapon: document.getElementById('slot-weapon'),
            slotLaser: document.getElementById('slot-laser'),
            slotNet: document.getElementById('slot-net'),
            countLaser: document.getElementById('count-laser'),
            countNet: document.getElementById('count-net'),
            weaponIcon: document.getElementById('weapon-icon'),
            weaponName: document.getElementById('weapon-name'),
        };

        // ê²Œì„ ìƒíƒœ
        let state = {
            active: false,
            paused: false,
            score: 0,
            coins: 0,
            
            // ìŠ¤íƒ¯
            clickDamage: 1,
            upgradeCost: 30,

            // ì¸ë²¤í† ë¦¬
            shotgunLevel: 0, // 0: ë¯¸ë³´ìœ , 1~5: ë ˆë²¨
            consumables: {
                laser: 0,
                net: 0
            },
            
            // í˜„ì¬ ëª¨ë“œ: 'WEAPON', 'LASER', 'NET', 'PLACING_GODZILLA'
            actionMode: 'WEAPON', 

            // ì„¸ì…˜ ë°ì´í„°
            killedInSession: 0,
            pets: [], // ì—¬ëŸ¬ ë§ˆë¦¬ ê³ ì§ˆë¼
            
            hats: [],
            particles: [],
            texts: [],
            
            lastTime: 0,
            spawnTimer: 0,
            spawnInterval: 1500,
            animationId: null
        };

        // --- ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ---
        function loadData() {
            const d = localStorage;
            if(d.getItem('ht_coins')) state.coins = parseInt(d.getItem('ht_coins'));
            if(d.getItem('ht_dmg')) state.clickDamage = parseInt(d.getItem('ht_dmg'));
            if(d.getItem('ht_cost')) state.upgradeCost = parseInt(d.getItem('ht_cost'));
            if(d.getItem('ht_gun_lv')) state.shotgunLevel = parseInt(d.getItem('ht_gun_lv'));
            // êµ¬ë²„ì „ í˜¸í™˜: hasShotgunì´ ìˆìœ¼ë©´ ë ˆë²¨ 1ë¡œ ë³€í™˜
            else if(d.getItem('ht_gun') === '1') state.shotgunLevel = 1;
            
            // ì†Œëª¨í’ˆ ìˆ˜ëŸ‰ ë¡œë“œ
            if(d.getItem('ht_lasers')) state.consumables.laser = parseInt(d.getItem('ht_lasers'));
            if(d.getItem('ht_nets')) state.consumables.net = parseInt(d.getItem('ht_nets'));

            updateUI();
        }

        function saveData() {
            const d = localStorage;
            d.setItem('ht_coins', state.coins);
            d.setItem('ht_dmg', state.clickDamage);
            d.setItem('ht_cost', state.upgradeCost);
            d.setItem('ht_gun_lv', state.shotgunLevel);
            d.setItem('ht_lasers', state.consumables.laser);
            d.setItem('ht_nets', state.consumables.net);
        }

        // ì‚°íƒ„ì´ ë²”ìœ„ ê³„ì‚° (ë ˆë²¨ ê¸°ë°˜)
        // ë ˆë²¨ 5ì—ì„œ min(width, height) / 3
        function getShotgunRange() {
            if (state.shotgunLevel <= 0) return 0;
            const maxRange = Math.min(canvas.width, canvas.height) / 3;
            const minRange = 60; // ë ˆë²¨ 1 ê¸°ë³¸ ë²”ìœ„
            // ë ˆë²¨ 1~5ë¥¼ minRange~maxRangeë¡œ ì„ í˜• ë³´ê°„
            return minRange + (maxRange - minRange) * (state.shotgunLevel - 1) / 4;
        }

        // ì‚°íƒ„ì´ ì—…ê·¸ë ˆì´ë“œ ë¹„ìš© (400, 600, 900, 1350, 2025)
        function getShotgunUpgradeCost() {
            const baseCosts = [400, 600, 900, 1350, 2025];
            if (state.shotgunLevel >= 5) return null; // ìµœëŒ€ ë ˆë²¨
            return baseCosts[state.shotgunLevel];
        }

        // --- ìº”ë²„ìŠ¤ ë¦¬ì‚¬ì´ì§• ---
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const randomColor = () => ['#F56565', '#ED8936', '#ECC94B', '#48BB78', '#4299E1', '#9F7AEA', '#ED64A6'][randomInt(0, 6)];

        // --- í´ë˜ìŠ¤ ì •ì˜ ---

        class Particle {
            constructor(x, y, color, speed=5) {
                this.x = x; this.y = y; this.color = color;
                this.vx = (Math.random()-0.5)*speed; this.vy = (Math.random()-0.5)*speed;
                this.alpha = 1; this.radius = Math.random()*3+2;
            }
            update() {
                this.x+=this.vx; this.y+=this.vy; this.vy+=0.5; this.alpha-=0.05;
            }
            draw() {
                ctx.save(); ctx.globalAlpha = Math.max(0, this.alpha);
                ctx.fillStyle = this.color; ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2); ctx.fill();
                ctx.restore();
            }
        }

        class FloatingText {
            constructor(x, y, text, color) {
                this.x = x; this.y = y; this.text = text; this.color = color;
                this.life = 60; this.vy = -1;
            }
            update() { this.y += this.vy; this.life--; }
            draw() {
                ctx.save(); ctx.globalAlpha = Math.max(0, this.life/60);
                ctx.fillStyle = this.color; ctx.font = "bold 20px Jua";
                ctx.strokeStyle = "black"; ctx.lineWidth = 3;
                ctx.strokeText(this.text, this.x, this.y); ctx.fillText(this.text, this.x, this.y);
                ctx.restore();
            }
        }

        class Godzilla {
            constructor(x, y) {
                this.x = x; this.y = y;
                this.range = 200;
                this.damage = 3;
                this.cooldown = 0;
            }
            update(hats) {
                if(this.cooldown > 0) this.cooldown--;
                
                let target = null;
                let minDist = this.range;

                hats.forEach(hat => {
                    const dist = Math.hypot(hat.x - this.x, hat.y - this.y);
                    if (dist < this.range) {
                        // 1. ìŠ¬ë¡œìš° íš¨ê³¼
                        hat.speedModifier = 0.5;
                        if(dist < minDist) { minDist = dist; target = hat; }
                    }
                });

                // 2. ê³µê²© (30í”„ë ˆì„ = 0.5ì´ˆ)
                if (target && this.cooldown <= 0) {
                    this.cooldown = 30;
                    target.takeDamage(this.damage);
                    createParticles(target.x, target.y, '#48BB78', 3);
                    
                    // ë¹” íš¨ê³¼
                    ctx.save(); ctx.strokeStyle = '#48BB78'; ctx.lineWidth = 3;
                    ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(target.x, target.y);
                    ctx.stroke(); ctx.restore();
                    
                    checkKill(target);
                }
            }
            draw() {
                ctx.save(); ctx.translate(this.x, this.y);
                // ë²”ìœ„
                ctx.beginPath(); ctx.arc(0,0,this.range,0,Math.PI*2);
                ctx.fillStyle = 'rgba(72,187,120,0.1)'; ctx.fill();
                // ëª¸ì²´
                ctx.fillStyle = '#2F855A'; ctx.beginPath(); ctx.arc(0,0,20,0,Math.PI*2); ctx.fill();
                // ëˆˆ
                ctx.fillStyle = 'white';
                ctx.beginPath(); ctx.arc(-8,-5,5,0,Math.PI*2); ctx.arc(8,-5,5,0,Math.PI*2); ctx.fill();
                ctx.fillStyle = 'black';
                ctx.beginPath(); ctx.arc(-8,-5,2,0,Math.PI*2); ctx.arc(8,-5,2,0,Math.PI*2); ctx.fill();
                ctx.restore();
            }
        }

        class HatMonster {
            constructor() {
                this.width = 70; this.height = 50;
                this.x = randomInt(this.width, canvas.width - this.width);
                this.y = -60;
                
                const scoreFactor = Math.floor(state.score/5);
                const upgradeFactor = state.clickDamage - 1;
                this.hp = randomInt(1 + upgradeFactor, 20 + scoreFactor + upgradeFactor);
                this.maxHp = this.hp;
                this.color = randomColor();

                // ê³µê²©ë ¥ ê¸°ë°˜ ì†ë„ ê³„ì‚° (ê³µê²©ë ¥ 3ì„ ê¸°ì¤€ìœ¼ë¡œ í˜„ì¬ ì†ë„ê°€ ë‚˜ì˜¤ë„ë¡)
                // ê³µê²©ë ¥ 1: 0.33ë°°, ê³µê²©ë ¥ 2: 0.67ë°°, ê³µê²©ë ¥ 3: 1ë°°, ê³µê²©ë ¥ 4: 1.33ë°° ...
                const damageSpeedFactor = state.clickDamage / 3;
                const scoreSpeedFactor = 1 + (state.score / 200); // ì ìˆ˜ì— ë”°ë¥¸ ì ì§„ì  ì¦ê°€
                const speedBase = damageSpeedFactor * scoreSpeedFactor;
                this.baseVy = randomInt(1, 3) * speedBase;
                this.vx = (Math.random()-0.5) * 2 * damageSpeedFactor;
                
                this.speedModifier = 1.0;
                this.hitStopTimer = 0; // íƒ€ê²© ì‹œ ë©ˆì¶¤ íƒ€ì´ë¨¸
                this.freezeTimer = 0; // ê·¸ë¬¼ íš¨ê³¼
                this.hitTimer = 0; // í”¼ê²© íš¨ê³¼ (ìƒ‰ìƒ)
            }
            
            update() {
                // ìƒíƒœ ì´ìƒ ì²´í¬
                if (this.freezeTimer > 0) {
                    this.freezeTimer--;
                    return 'active'; // ì›€ì§ì´ì§€ ì•ŠìŒ
                }
                
                if (this.hitStopTimer > 0) {
                    this.hitStopTimer--;
                    return 'active'; // ë©ˆì¹«
                }

                // ì´ë™
                this.x += this.vx * this.speedModifier;
                this.y += this.baseVy * this.speedModifier;
                
                this.speedModifier = 1.0; // ë§¤ í”„ë ˆì„ ì´ˆê¸°í™” (ê³ ì§ˆë¼ ì˜¤ë¼ ë°–ì´ë©´ ë³µêµ¬)

                if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                if (this.y > getGameOverLine()) return 'gameover';
                
                if (this.hitTimer > 0) this.hitTimer--;
                return 'active';
            }

            draw() {
                ctx.save(); ctx.translate(this.x, this.y);
                
                // í”¼ê²© ì‹œ
                if (this.hitTimer > 0) { ctx.scale(1.1, 1.1); ctx.fillStyle = '#fff'; }
                // ì–¼ìŒ(ê·¸ë¬¼) íš¨ê³¼
                else if (this.freezeTimer > 0) { ctx.fillStyle = '#90CDF4'; }
                else { ctx.fillStyle = this.color; }

                ctx.beginPath();
                ctx.roundRect(-35, -10, 70, 15, 5); 
                ctx.roundRect(-25, -50, 50, 45, 10); ctx.fill();
                
                // ë 
                ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.fillRect(-25, -15, 50, 8);
                
                // ëˆˆ
                ctx.fillStyle = 'white';
                ctx.beginPath(); ctx.arc(-10,-25,8,0,Math.PI*2); ctx.arc(10,-25,8,0,Math.PI*2); ctx.fill();
                ctx.fillStyle = 'black';
                ctx.beginPath(); ctx.arc(-10,-22,3,0,Math.PI*2); ctx.arc(10,-22,3,0,Math.PI*2); ctx.fill();

                // ì²´ë ¥
                ctx.fillStyle = 'white'; ctx.font = 'bold 24px Jua'; ctx.textAlign = 'center';
                ctx.lineWidth = 3; ctx.strokeStyle = 'black';
                ctx.strokeText(this.hp, 0, -65); ctx.fillText(this.hp, 0, -65);

                // ê·¸ë¬¼ ì•„ì´ì½˜ (ì •ì§€ ì¤‘ì¼ ë•Œ)
                if (this.freezeTimer > 0) {
                    ctx.font = '20px Arial';
                    ctx.fillText("ğŸ•¸ï¸", 0, 0);
                }

                ctx.restore();
            }

            isClicked(mx, my) {
                return Math.hypot(mx - this.x, my - this.y + 20) < 60;
            }

            takeDamage(amount) {
                this.hp -= amount;
                this.hitTimer = 5; 
                this.hitStopTimer = 10; // íƒ€ê²© ì‹œ ì•½ 0.16ì´ˆ ë©ˆì¶¤ (íƒ€ê²©ê°)
                this.y -= 5; // ë„‰ë°±
            }
        }

        // --- ë¡œì§ ---

        function createParticles(x, y, color, count) {
            for(let i=0; i<count; i++) state.particles.push(new Particle(x, y, color));
        }

        function checkKill(hat) {
            if (hat.hp <= 0) {
                const idx = state.hats.indexOf(hat);
                if (idx > -1) {
                    state.hats.splice(idx, 1);
                    createParticles(hat.x, hat.y, hat.color, 15);
                    
                    let reward = 1;
                    if(hat.maxHp >= 21) reward = 10;
                    else if(hat.maxHp >= 11) reward = 5;
                    else if(hat.maxHp >= 6) reward = 2;
                    
                    state.score += reward;
                    state.coins += reward;
                    state.texts.push(new FloatingText(hat.x, hat.y-20, `+${reward}`, "#FFF"));
                    
                    state.killedInSession++;
                    if(state.killedInSession % 2 === 0) {
                        state.score++; state.coins++;
                        state.texts.push(new FloatingText(hat.x, hat.y-40, "Bonus!", "#F6E05E"));
                    }
                    updateUI();
                }
            }
        }

        function animate(timestamp) {
            if (!state.active || state.paused) return;
            const dt = timestamp - state.lastTime;
            state.lastTime = timestamp;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ë°°ê²½
            let grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            grad.addColorStop(0, '#1a202c');
            grad.addColorStop(1, '#2d3748');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ê²Œì„ ì˜¤ë²„ ë¼ì¸ (ê²½ê³ ì„ )
            const gameOverY = getGameOverLine();
            ctx.save();
            ctx.strokeStyle = 'rgba(229, 62, 62, 0.5)';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 5]);
            ctx.beginPath();
            ctx.moveTo(0, gameOverY);
            ctx.lineTo(canvas.width, gameOverY);
            ctx.stroke();
            ctx.restore();

            // í« ì—…ë°ì´íŠ¸
            state.pets.forEach(pet => {
                pet.update(state.hats);
                pet.draw();
            });

            // ìƒì„±ê¸° (ì‚°íƒ„ì´ ë ˆë²¨ì— ë”°ë¼ ìŠ¤í° ì†ë„ ì¦ê°€: Lv0=1ë°°, Lv5=3ë°°)
            state.spawnTimer += dt;
            // ìŠ¤í° ë°°ìœ¨: ë ˆë²¨ 0=1, ë ˆë²¨ 1=1.4, ë ˆë²¨ 2=1.8, ë ˆë²¨ 3=2.2, ë ˆë²¨ 4=2.6, ë ˆë²¨ 5=3
            const spawnMultiplier = 1 + (state.shotgunLevel * 0.4);
            const effectiveSpawnInterval = state.spawnInterval / spawnMultiplier;
            if (state.spawnTimer > effectiveSpawnInterval) {
                state.hats.push(new HatMonster());
                state.spawnTimer = 0;
                if (state.spawnInterval > 500) state.spawnInterval -= 10;
            }

            // ëª¨ì ì—…ë°ì´íŠ¸
            for (let i = state.hats.length - 1; i >= 0; i--) {
                const hat = state.hats[i];
                const status = hat.update();
                if (status === 'gameover') { gameOver("ë°©ì–´ì„ ì´ ëš«ë ¸ìŠµë‹ˆë‹¤!"); return; }
                hat.draw();
            }

            if (state.hats.length >= MAX_MONSTERS) {
                gameOver("í™”ë©´ì— ê´´ë¬¼ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤!");
                return;
            }

            // ì´í™íŠ¸
            for (let i = state.particles.length - 1; i >= 0; i--) {
                const p = state.particles[i]; p.update(); p.draw();
                if (p.alpha <= 0) state.particles.splice(i, 1);
            }
            for (let i = state.texts.length - 1; i >= 0; i--) {
                const t = state.texts[i]; t.update(); t.draw();
                if (t.life <= 0) state.texts.splice(i, 1);
            }

            // ì¡°ì¤€ì„  (íŠ¹ìˆ˜ ëª¨ë“œì¼ ë•Œ)
            if (state.actionMode === 'PLACING_GODZILLA') {
                showNotification("ê³ ì§ˆë¼ë¥¼ ë°°ì¹˜í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”");
            } else if (state.actionMode === 'LASER') {
                showNotification("ë ˆì´ì € ëª©í‘œ ì§€ì  í´ë¦­");
            } else if (state.actionMode === 'NET') {
                showNotification("ê·¸ë¬¼ íˆ¬ì²™ ì§€ì  í´ë¦­");
            } else {
                hideNotification();
            }

            ui.monsters.innerText = state.hats.length;
            state.animationId = requestAnimationFrame(animate);
        }

        // --- ì…ë ¥ í•¸ë“¤ëŸ¬ ---
        function handleInput(e) {
            if (!state.active || state.paused) return;

            const rect = canvas.getBoundingClientRect();
            const cx = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
            const cy = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            const mx = cx - rect.left;
            const my = cy - rect.top;

            // 1. ê³ ì§ˆë¼ ë°°ì¹˜ ëª¨ë“œ
            if (state.actionMode === 'PLACING_GODZILLA') {
                state.pets.push(new Godzilla(mx, my));
                state.texts.push(new FloatingText(mx, my, "ë°°ì¹˜ ì™„ë£Œ!", "#48BB78"));
                state.actionMode = 'WEAPON'; // ë¬´ê¸°ë¡œ ë³µê·€
                return;
            }

            // 2. ë ˆì´ì € ì‚¬ìš© (ê°€ë¡œì¤„ ì‚­ì œ)
            if (state.actionMode === 'LASER') {
                if (state.consumables.laser > 0) {
                    state.consumables.laser--;
                    // ì´í™íŠ¸: ê°€ë¡œ ë¹”
                    createParticles(canvas.width/2, my, '#F6E05E', 30);
                    ctx.save();
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.fillRect(0, my - 20, canvas.width, 40); // ìˆœê°„ ë²ˆì©ì„ (ë‹¤ìŒ í”„ë ˆì„ì— ì‚¬ë¼ì§)
                    ctx.restore();

                    // íŒì •: Yì¶• ë²”ìœ„ Â±30
                    for (let i = state.hats.length - 1; i >= 0; i--) {
                        const hat = state.hats[i];
                        if (Math.abs(hat.y - my) < 40) {
                            hat.takeDamage(9999);
                            checkKill(hat);
                        }
                    }
                    saveData();
                    updateUI();
                }
                state.actionMode = 'WEAPON';
                return;
            }

            // 3. ê·¸ë¬¼ ì‚¬ìš© (ë²”ìœ„ ì •ì§€)
            if (state.actionMode === 'NET') {
                if (state.consumables.net > 0) {
                    state.consumables.net--;
                    const range = 200;
                    
                    // ì´í™íŠ¸: ê·¸ë¬¼ë§
                    createParticles(mx, my, '#90CDF4', 20);
                    
                    state.hats.forEach(hat => {
                        if (Math.hypot(hat.x - mx, hat.y - my) < range) {
                            hat.freezeTimer = 180; // 3ì´ˆ (60 * 3)
                            state.texts.push(new FloatingText(hat.x, hat.y, "ì •ì§€!", "#90CDF4"));
                        }
                    });
                    saveData();
                    updateUI();
                }
                state.actionMode = 'WEAPON';
                return;
            }

            // 4. ì¼ë°˜ ë¬´ê¸° (ê¸°ë³¸ / ì‚°íƒ„ì´)
            if (state.shotgunLevel > 0) {
                // ì‚°íƒ„ì´: ë²”ìœ„ ê³µê²© (ë ˆë²¨ì— ë”°ë¼ ë²”ìœ„ ì¦ê°€)
                const range = getShotgunRange();
                createParticles(mx, my, '#ED8936', 8);
                state.hats.forEach(hat => {
                    if (Math.hypot(hat.x - mx, hat.y - my) < range) {
                        hat.takeDamage(state.clickDamage);
                        createParticles(hat.x, hat.y, '#FFF', 2);
                        checkKill(hat);
                    }
                });
                // ë²”ìœ„ ì´í™íŠ¸
                ctx.save(); ctx.beginPath(); ctx.arc(mx, my, range, 0, Math.PI*2);
                ctx.strokeStyle = 'rgba(237,137,54,0.5)'; ctx.lineWidth = 2;
                ctx.stroke(); ctx.restore();

            } else {
                // ê¸°ë³¸: ë‹¨ì¼ íƒ€ê²Ÿ (ì •í™•ë„ í•„ìš”)
                for (let i = state.hats.length - 1; i >= 0; i--) {
                    const hat = state.hats[i];
                    if (hat.isClicked(mx, my)) {
                        hat.takeDamage(state.clickDamage);
                        createParticles(hat.x, hat.y, '#FFF', 2);
                        checkKill(hat);
                        break; // í•œ ë²ˆì— í•˜ë‚˜
                    }
                }
            }
        }

        // --- ìƒì /UI ë¡œì§ ---

        function updateUI() {
            ui.score.innerText = state.score;
            ui.coins.innerText = state.coins;
            ui.dmg.innerText = state.clickDamage;
            
            // ìƒì  ì •ë³´
            ui.shopCoin.innerText = state.coins;
            ui.shopDmg.innerText = state.clickDamage;
            ui.btnUpgrade.innerText = `ê°•í™” (${state.upgradeCost})`;
            ui.btnUpgrade.disabled = state.coins < state.upgradeCost;

            // ì‚°íƒ„ì´ ë²„íŠ¼ (ë ˆë²¨ ì‹œìŠ¤í…œ)
            const gunCost = getShotgunUpgradeCost();
            const gunLvEl = document.getElementById('shop-gun-lv');
            const gunDescEl = document.getElementById('shop-gun-desc');

            if (state.shotgunLevel >= 5) {
                // ìµœëŒ€ ë ˆë²¨
                gunLvEl.innerText = 'Lv.5 (MAX)';
                gunDescEl.innerText = `ë²”ìœ„: ${Math.round(getShotgunRange())}px`;
                ui.btnBuyGun.innerText = "ìµœëŒ€ ë ˆë²¨";
                ui.btnBuyGun.disabled = true;
                ui.btnBuyGun.classList.add('btn-equip');
            } else if (state.shotgunLevel > 0) {
                // ë ˆë²¨ 1~4: ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥
                gunLvEl.innerText = `Lv.${state.shotgunLevel}`;
                gunDescEl.innerText = `ë²”ìœ„: ${Math.round(getShotgunRange())}px â†’ ${Math.round(getShotgunRange() + (Math.min(canvas.width, canvas.height)/3 - 60)/4)}px`;
                ui.btnBuyGun.innerText = `ê°•í™” (${gunCost})`;
                ui.btnBuyGun.disabled = state.coins < gunCost;
                ui.btnBuyGun.classList.remove('btn-equip');
            } else {
                // ë¯¸ë³´ìœ 
                gunLvEl.innerText = '';
                gunDescEl.innerText = 'ì˜êµ¬ ì¥ì°© / ë²”ìœ„ ê³µê²©';
                ui.btnBuyGun.innerText = `êµ¬ë§¤ (${gunCost})`;
                ui.btnBuyGun.disabled = state.coins < gunCost;
                ui.btnBuyGun.classList.remove('btn-equip');
            }

            // ì¸ê²Œì„ ì•„ì´ì½˜ ë³€ê²½
            if (state.shotgunLevel > 0) {
                ui.weaponIcon.innerText = "ğŸ”«";
                ui.weaponName.innerText = `Lv.${state.shotgunLevel}`;
            } else {
                ui.weaponIcon.innerText = "ğŸ‘†";
                ui.weaponName.innerText = "ê¸°ë³¸";
            }

            // ì•„ì´í…œ ìˆ˜ëŸ‰ í‘œì‹œ
            ui.countLaser.innerText = state.consumables.laser;
            ui.countNet.innerText = state.consumables.net;

            // ìŠ¬ë¡¯ í™œì„±í™” ìƒíƒœ
            ui.slotWeapon.classList.toggle('active', state.actionMode === 'WEAPON');
            ui.slotLaser.classList.toggle('active', state.actionMode === 'LASER');
            ui.slotNet.classList.toggle('active', state.actionMode === 'NET');
        }

        function selectMode(mode) {
            if (!state.active) return;
            
            // ìˆ˜ëŸ‰ ì²´í¬
            if (mode === 'LASER' && state.consumables.laser <= 0) {
                showNotification("ë ˆì´ì €ê°€ ì—†ìŠµë‹ˆë‹¤!");
                setTimeout(hideNotification, 1000);
                return;
            }
            if (mode === 'NET' && state.consumables.net <= 0) {
                showNotification("ê·¸ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤!");
                setTimeout(hideNotification, 1000);
                return;
            }

            state.actionMode = mode;
            updateUI();
        }

        // ì•„ì´í…œ êµ¬ë§¤
        ui.btnUpgrade.onclick = () => {
            if(state.coins >= state.upgradeCost) {
                state.coins -= state.upgradeCost;
                state.clickDamage++;
                state.upgradeCost = Math.floor(state.upgradeCost * 1.6);
                saveData(); updateUI();
            }
        };

        ui.btnBuyGun.onclick = () => {
            const cost = getShotgunUpgradeCost();
            if(cost && state.coins >= cost) {
                state.coins -= cost;
                state.shotgunLevel++;
                saveData(); updateUI();
            }
        };

        window.buyConsumable = (type, cost) => {
            if(state.coins >= cost) {
                state.coins -= cost;
                state.consumables[type]++;
                saveData(); updateUI();
            }
        };

        window.buyGodzilla = () => {
            if(state.coins >= 400) {
                state.coins -= 400;
                closeShop(); // ìƒì  ë‹«ê³ 
                state.actionMode = 'PLACING_GODZILLA'; // ë°°ì¹˜ ëª¨ë“œ ì§„ì…
                updateUI();
                saveData();
            }
        };

        function openShop() {
            state.paused = true;
            ui.shopModal.style.display = 'flex';
            updateUI();
        }
        function closeShop() {
            ui.shopModal.style.display = 'none';
            state.paused = false;
            if(state.active) {
                state.lastTime = performance.now();
                requestAnimationFrame(animate);
            }
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        let notifyTimeout;
        function showNotification(msg) {
            ui.notification.innerText = msg;
            ui.notification.style.opacity = 1;
            clearTimeout(notifyTimeout);
        }
        function hideNotification() {
            ui.notification.style.opacity = 0;
        }

        // ê²Œì„ íë¦„
        function startGame() {
            state.active = true;
            state.paused = false;
            state.score = 0;
            state.killedInSession = 0;
            state.hats = [];
            state.pets = [];
            state.particles = [];
            state.texts = [];
            state.actionMode = 'WEAPON';
            
            ui.menu.style.display = 'none';
            ui.shopModal.style.display = 'none';
            
            state.lastTime = performance.now();
            updateUI();
            animate(state.lastTime);
        }

        function gameOver(reason) {
            state.active = false;
            cancelAnimationFrame(state.animationId);
            state.pets = []; // ê²Œì„ ì˜¤ë²„ ì‹œ í« ì´ˆê¸°í™” (ì„¸ì…˜ í•œì •)
            saveData();
            
            ui.menu.style.display = 'flex';
            document.getElementById('game-over-msg').innerText = reason;
            document.getElementById('game-over-msg').classList.remove('hidden');
            document.getElementById('final-score-display').innerText = `íšë“: ${state.score}`;
            document.getElementById('final-score-display').classList.remove('hidden');
            document.getElementById('start-btn').innerText = "ë‹¤ì‹œ ë„ì „";
            
            hideNotification();
        }

        document.getElementById('start-btn').onclick = startGame;
        document.getElementById('btn-open-shop').onclick = openShop;
        document.addEventListener('keydown', (e) => {
            if(e.code === 'Space' && state.active) gameOver("ì‘ì „ ì¤‘ë‹¨");
        });
        canvas.addEventListener('pointerdown', handleInput);

        window.openShop = openShop; 
        window.closeShop = closeShop;
        loadData();

    </script>
</body>
</html>